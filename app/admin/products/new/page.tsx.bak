'use client';

import React, { useState } from 'react';
import { Form, Input, InputNumber, Select, Button, Card, message, DatePicker, Row, Col, Divider } from 'antd';
import { CloudUploadOutlined, SaveOutlined, ArrowLeftOutlined, RobotOutlined, ThunderboltOutlined } from '@ant-design/icons';
import { useRouter } from 'next/navigation';
import { db } from '@/lib/firebase';
import { collection, addDoc, serverTimestamp } from 'firebase/firestore';

const { Option } = Select;
const { TextArea } = Input;

export default function NewProductPage() {
    const [form] = Form.useForm();
    const router = useRouter();
    const [messageApi, contextHolder] = message.useMessage();
    const [loading, setLoading] = useState(false);
    const [aiLoading, setAiLoading] = useState(false);
    const [selectedCategory, setSelectedCategory] = useState<string | null>(null);
    const [categoryModalVisible, setCategoryModalVisible] = useState(true);
    const [aiModalVisible, setAiModalVisible] = useState(false);
    const [aiInputText, setAiInputText] = useState('');
    const [categoryInfo, setCategoryInfo] = useState<{ name: string, code: string, icon: React.ReactNode } | null>(null);

    const categories = [
        { name: 'Laptops', code: 'Computers/Laptops', icon: <img src="https://cdn-icons-png.flaticon.com/512/428/428001.png" alt="Laptop" width={48} /> },
        { name: 'Desktops', code: 'Computers/Desktop Computers', icon: <img src="https://cdn-icons-png.flaticon.com/512/2933/2933245.png" alt="Desktop" width={48} /> },
        { name: 'Monitors', code: 'Computers/Monitors', icon: <img src="https://cdn-icons-png.flaticon.com/512/5681/5681966.png" alt="Monitor" width={48} /> },
    ];

    const generateAIContent = async (action: 'optimize_title' | 'optimize_description' | 'autofill_specs', inputData: string) => {
        setAiLoading(true);
        try {
            const response = await fetch('/api/ai/product', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action,
                    currentData: inputData,
                    category: selectedCategory || 'General Product'
                })
            });
            const data = await response.json();

            if (!data.success) {
                if (data.isDemo) {
                    messageApi.warning('AI Demo Mode: Please add GEMINI_API_KEY to .env.local for real results.');
                    // Return mock High-Quality data for demo
                    if (action === 'optimize_title') return "Premium " + inputData + " - High Performance";
                    if (action === 'optimize_description') return "Experience the power of " + inputData + ". Designed for professionals who demand the best.";
                    if (action === 'autofill_specs') return JSON.stringify({
                        brand: "Apple", model_number: "Mock-M3",
                        processor_type: "M3 Pro", ram_size: 18, ssd_capacity: 512,
                        condition: "Brand New"
                    });
                }
                throw new Error(data.error || 'AI request failed');
            }
            return data.data;
        } catch (error) {
            console.error(error);
            messageApi.error('AI Generation failed');
            return null;
        } finally {
            setAiLoading(false);
        }
    };

    const handleAIOptimize = async () => {
        const currentTitle = form.getFieldValue('title_en');
        if (!currentTitle) return messageApi.info('Please enter a title first');

        try {
            // Step 1: Optimize the title
            const optimizedTitle = await generateAIContent('optimize_title', currentTitle);
            if (!optimizedTitle) return;

            const cleanTitle = optimizedTitle.replace(/^"|"$/g, '');
            form.setFieldsValue({ title_en: cleanTitle });

            // Step 2: Generate description based on optimized title
            const generatedDesc = await generateAIContent('optimize_description', cleanTitle);
            if (generatedDesc) {
                form.setFieldsValue({ short_description_en: generatedDesc.replace(/^"|"$/g, '') });
            }

            messageApi.success('Title and Description optimized!');
        } catch (error) {
            messageApi.error('Optimization failed');
        }
    };

    const handleAIAutofill = async () => {
        if (!aiInputText) return;
        const result = await generateAIContent('autofill_specs', aiInputText);
        if (result) {
            try {
                // remove markdown code blocks if any
                const cleanJson = result.replace(/```json/g, '').replace(/```/g, '');
                const parsed = JSON.parse(cleanJson);
                form.setFieldsValue({
                    brand: parsed.brand,
                    model_number: parsed.model_number,
                    color: parsed.color,
                    processor_type: parsed.processor_type,
                    ram_size: parsed.ram_size,
                    ssd_capacity: parsed.ssd_capacity,
                    screen_size: parsed.screen_size,
                    condition: parsed.condition
                });
                messageApi.success('Specs auto-filled from text!');
                setAiModalVisible(false);
            } catch (e) {
                console.error("JSON Parse error", e);
                messageApi.error('Failed to parse AI response');
            }
        }
    };

    const onFinish = async (values: any) => {
        setLoading(true);
        try {
            const productData = {
                category_code: values.category_code,
                shop_sku: values.shop_sku,
                title: { en: values.title_en },
                short_description: { en: values.short_description_en },
                brand: values.brand,
                upc: values.upc,
                model_number: values.model_number,
                manufacturer_part_number: values.manufacturer_part_number,
                main_image_url: values.image_url,
                variant_group_code: values.variant_group_code,

                specifications: {
                    condition: values.condition,
                    processor_type: values.processor_type,
                    ram_size: values.ram_size,
                    ssd_capacity: values.ssd_capacity,
                    graphics_card: values.graphics_card,
                    color: values.color,
                    screen_size: values.screen_size,
                    platform: values.platform,
                    convertible: values.convertible,
                    screen_size_type: values.screen_size_type,
                    preloaded_os: values.preloaded_os,
                    builtin_monitor: values.builtin_monitor,
                    desktop_type: values.desktop_type,
                },

                offer: {
                    sku: values.offer_sku,
                    product_id_type: values.product_id_type,
                    description: values.offer_description,
                    internal_description: values.internal_description,
                    price: values.price,
                    price_additional_info: values.price_additional_info,
                    quantity: values.quantity,
                    min_quantity_alert: values.min_quantity_alert,
                    state: values.state,
                    available_start_date: values.available_start_date ? values.available_start_date.toISOString() : null,
                    available_end_date: values.available_end_date ? values.available_end_date.toISOString() : null,
                    logistic_class: values.logistic_class,
                    discount_price: values.discount_price,
                    discount_start_date: values.discount_start_date ? values.discount_start_date.toISOString() : null,
                    discount_end_date: values.discount_end_date ? values.discount_end_date.toISOString() : null,
                    warranty_days: values.warranty_days,
                },

                ehf_fees: {
                    ab: values.ehf_amount_ab,
                    bc: values.ehf_amount_bc,
                    mb: values.ehf_amount_mb,
                    nb: values.ehf_amount_nb,
                    nl: values.ehf_amount_nl,
                    ns: values.ehf_amount_ns,
                    nt: values.ehf_amount_nt,
                    nu: values.ehf_amount_nu,
                    on: values.ehf_amount_on,
                    pe: values.ehf_amount_pe,
                    qc: values.ehf_amount_qc,
                    sk: values.ehf_amount_sk,
                    yt: values.ehf_amount_yt,
                },

                status: values.quantity > 0 ? 'active' : 'inactive',
                marketplace_sync: {
                    bestbuy: {
                        sync_enabled: true
                    }
                },
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp(),
            };

            await addDoc(collection(db, 'products'), productData);
            messageApi.success('Product created successfully!');
            router.push('/admin/products');
        } catch (error) {
            console.error(error);
            messageApi.error('Failed to create product.');
        } finally {
            setLoading(false);
        }
    };

    const handleCategoryChange = (value: string) => {
        const cat = categories.find(c => c.code === value);
        if (cat) {
            setCategoryInfo(cat);
            setSelectedCategory(value);
        }
    };

    const handleCategorySelect = (cat: typeof categories[0]) => {
        setSelectedCategory(cat.code);
        setCategoryInfo(cat);
        form.setFieldsValue({ category_code: cat.code });
        setCategoryModalVisible(false);
    };

    const onChangeCategory = () => {
        setCategoryModalVisible(true);
    };

    return (
        <div style={{ maxWidth: 1400, margin: '0 auto', paddingBottom: 80 }}>
            {contextHolder}
            {/* Category Selection Modal */}
            {categoryModalVisible && (
                <div style={{
                    position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
                    zIndex: 1000, background: 'rgba(0,0,0,0.5)', backdropFilter: 'blur(5px)',
                    display: 'flex', alignItems: 'center', justifyContent: 'center'
                }}>
                    <div style={{ background: '#fff', borderRadius: 16, padding: 40, width: '100%', maxWidth: 700, textAlign: 'center' }}>
                        <h2 style={{ fontSize: 24, fontWeight: 700, marginBottom: 8 }}>Select Product Category</h2>
                        <p style={{ color: '#666', marginBottom: 32 }}>Choose the type of product you are listing to see relevant fields.</p>

                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 20 }}>
                            {categories.map(cat => (
                                <div
                                    key={cat.code}
                                    onClick={() => handleCategorySelect(cat)}
                                    style={{
                                        border: '1px solid #eee', borderRadius: 12, padding: 24, cursor: 'pointer',
                                        transition: 'all 0.2s', display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 12
                                    }}
                                    className="hover:border-black hover:bg-gray-50 hover:shadow-lg"
                                >
                                    <div style={{ margin: '0 auto' }}>{cat.icon}</div>
                                    <span style={{ fontWeight: 600 }}>{cat.name}</span>
                                </div>
                            ))}
                        </div>
                        <Button type="text" style={{ marginTop: 24 }} onClick={() => router.back()}>Cancel</Button>
                    </div>
                </div>
            )}

            {/* Header Section */}
            <div style={{
                marginBottom: 32,
                padding: '24px 0',
                borderBottom: '1px solid #eaeaea',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'space-between'
            }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: 20 }}>
                    <Button
                        icon={<ArrowLeftOutlined />}
                        onClick={() => router.back()}
                        type="text"
                    />
                    <div>
                        <h1 style={{ fontSize: 28, fontWeight: 700, margin: 0, color: '#111', display: 'flex', alignItems: 'center', gap: 12 }}>
                            New Product Listing
                        </h1>
                        {categoryInfo && (
                            <div
                                onClick={onChangeCategory}
                                style={{
                                    display: 'inline-flex', alignItems: 'center', gap: 8,
                                    marginTop: 8, padding: '4px 12px', background: '#f5f5f5', borderRadius: 20,
                                    cursor: 'pointer', fontSize: 13, fontWeight: 500
                                }}
                            >
                                <span style={{ width: 16 }}>{categoryInfo.icon}</span>
                                {categoryInfo.name}
                                <span style={{ color: '#999', fontSize: 10 }}>â–¼</span>
                            </div>
                        )}
                    </div>
                </div>
                <div style={{ display: 'flex', gap: 12 }}>
                    <Button
                        icon={<RobotOutlined />}
                        onClick={() => setAiModalVisible(true)}
                        style={{ borderRadius: 8, background: '#e6f7ff', borderColor: '#bae7ff', color: '#096dd9' }}
                    >
                        AI Autofill
                    </Button>
                    <Button size="large" onClick={() => router.back()} style={{ borderRadius: 8 }}>Discard</Button>
                    <Button
                        type="primary"
                        size="large"
                        onClick={form.submit}
                        loading={loading}
                        icon={<SaveOutlined />}
                        style={{
                            minWidth: 140,
                            borderRadius: 8,
                            background: '#000',
                            boxShadow: '0 4px 12px rgba(0,0,0,0.1)'
                        }}
                    >
                        Publish Product
                    </Button>
                </div>
            </div>

            {/* AI Modal */}
            {aiModalVisible && (
                <div style={{
                    position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
                    zIndex: 2000, background: 'rgba(0,0,0,0.5)', backdropFilter: 'blur(5px)',
                    display: 'flex', alignItems: 'center', justifyContent: 'center'
                }}>
                    <div style={{ background: '#fff', borderRadius: 16, padding: 32, width: '100%', maxWidth: 600 }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 16 }}>
                            <div style={{ width: 40, height: 40, borderRadius: 20, background: '#e6f7ff', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                                <RobotOutlined style={{ fontSize: 24, color: '#1890ff' }} />
                            </div>
                            <div>
                                <h3 style={{ fontSize: 20, fontWeight: 700, margin: 0 }}>AI Spec Autofill</h3>
                                <p style={{ color: '#666', margin: 0, fontSize: 13 }}>Paste a raw product description below to auto-fill fields.</p>
                            </div>
                        </div>

                        <TextArea
                            rows={6}
                            placeholder="Paste product info here (e.g. 'Apple MacBook Pro 14 M3 Max, 36GB RAM, 1TB SSD, Space Black...')"
                            value={aiInputText}
                            onChange={(e) => setAiInputText(e.target.value)}
                            style={{ marginBottom: 20, fontSize: 14 }}
                        />

                        <div style={{ display: 'flex', justifyContent: 'flex-end', gap: 12 }}>
                            <Button onClick={() => setAiModalVisible(false)} disabled={aiLoading}>Cancel</Button>
                            <Button
                                type="primary"
                                icon={aiLoading ? <ThunderboltOutlined spin /> : <ThunderboltOutlined />}
                                onClick={handleAIAutofill}
                                loading={aiLoading}
                                disabled={!aiInputText}
                            >
                                Generate Specs
                            </Button>
                        </div>
                    </div>
                </div>
            )}

            {/* Main Form - Only visible when category is selected */}
            {!categoryModalVisible && (
                <Form
                    form={form}
                    layout="vertical"
                    onFinish={onFinish}
                    initialValues={{
                        product_id_type: 'UPC-A',
                        state: 'New',
                        logistic_class: 'Small Box',
                        category_code: undefined
                    }}
                >
                    <Row gutter={32}>
                        {/* Left Column - Main Details */}
                        <Col xs={24} lg={16}>
                            {/* SECTION 1: CORE DETAILS */}
                            <div style={{ marginBottom: 32 }}>
                                <h3 style={{ fontSize: 18, fontWeight: 600, marginBottom: 16 }}>Core Information</h3>
                                <Card variant="borderless" style={{ boxShadow: '0 2px 10px rgba(0,0,0,0.03)', borderRadius: 12 }}>
                                    <Row gutter={24}>
                                        <Col span={24}>
                                            <Form.Item name="title_en" label="Product Title" rules={[{ required: true }]}>
                                                <Input
                                                    size="large"
                                                    placeholder="e.g. Apple MacBook Pro 14 M3 Max"
                                                    style={{ fontWeight: 500 }}
                                                    suffix={
                                                        <ThunderboltOutlined
                                                            style={{ cursor: 'pointer', color: aiLoading ? '#ccc' : '#faad14' }}
                                                            title="AI Optimize Title & Description"
                                                            onClick={handleAIOptimize}
                                                        />
                                                    }
                                                />
                                            </Form.Item>
                                        </Col>

                                        <Col span={0}>
                                            {/* Hidden field as it's set by modal now */}
                                            <Form.Item name="category_code" label="Category" rules={[{ required: true }]}>
                                                <Input type="hidden" />
                                            </Form.Item>
                                        </Col>
                                        <Col span={24}>
                                            <Form.Item name="brand" label="Brand" rules={[{ required: true }, { pattern: /^[^<>]*$/ }]}>
                                                <Input size="large" placeholder="e.g. Apple" />
                                            </Form.Item>
                                        </Col>

                                        <Col span={24}>
                                            <Form.Item name="short_description_en" label="Short Description" rules={[{ required: true, max: 400 }]}>
                                                <div style={{ position: 'relative' }}>
                                                    <TextArea
                                                        rows={4}
                                                        style={{ resize: 'none', paddingBottom: 32 }}
                                                        placeholder="Enter a compelling product description..."
                                                    />
                                                    <div style={{ position: 'absolute', right: 10, bottom: 8 }}>
                                                        <Button
                                                            type="text"
                                                            size="small"
                                                            icon={<ThunderboltOutlined />}
                                                            onClick={handleAIOptimize}
                                                            loading={aiLoading}
                                                            style={{ color: '#faad14', fontSize: 12 }}
                                                        >
                                                            AI Optimize
                                                        </Button>
                                                    </div>
                                                </div>
                                            </Form.Item>
                                        </Col>

                                        <Col span={24}>
                                            <Form.Item name="image_url" label="Main Image URL" rules={[{ required: true, type: 'url' }]}>
                                                <Input size="large" prefix={<CloudUploadOutlined style={{ color: '#999' }} />} placeholder="https://..." />
                                            </Form.Item>
                                        </Col>
                                    </Row>
                                </Card>
                            </div>

                            {/* SECTION 2: SPECIFICATIONS */}
                            <div style={{ marginBottom: 32 }}>
                                <h3 style={{ fontSize: 18, fontWeight: 600, marginBottom: 16 }}>Technical Specifications</h3>
                                <Card variant="borderless" style={{ boxShadow: '0 2px 10px rgba(0,0,0,0.03)', borderRadius: 12, minHeight: 200 }}>

                                    <Row gutter={24}>
                                        <Col xs={24} md={12}>
                                            <Form.Item name="condition" label="Condition" rules={[{ required: true }]}>
                                                <Select size="large">
                                                    <Option value="Brand New">Brand New</Option>
                                                    <Option value="Open Box">Open Box</Option>
                                                    <Option value="Refurbished Excellent">Refurbished Excellent</Option>
                                                </Select>
                                            </Form.Item>
                                        </Col>
                                        <Col xs={24} md={12}>
                                            <Form.Item name="model_number" label="Model Number" rules={[{ required: true }]}>
                                                <Input size="large" />
                                            </Form.Item>
                                        </Col>

                                        {(selectedCategory?.includes('Laptops') || selectedCategory?.includes('Desktop')) && (
                                            <>
                                                <Col span={12}><Form.Item name="processor_type" label="Processor"><Input size="large" /></Form.Item></Col>
                                                <Col span={6}><Form.Item name="ram_size" label="RAM (GB)"><InputNumber size="large" style={{ width: '100%' }} /></Form.Item></Col>
                                                <Col span={6}><Form.Item name="ssd_capacity" label="SSD (GB)"><InputNumber size="large" style={{ width: '100%' }} /></Form.Item></Col>
                                                <Col span={12}><Form.Item name="graphics_card" label="Graphics Card"><Input size="large" /></Form.Item></Col>
                                                <Col span={12}><Form.Item name="color" label="Color"><Input size="large" /></Form.Item></Col>
                                            </>
                                        )}

                                        {selectedCategory?.includes('Laptops') && (
                                            <>
                                                <Col span={8}><Form.Item name="screen_size" label="Screen Size"><InputNumber size="large" style={{ width: '100%' }} /></Form.Item></Col>
                                                <Col span={8}><Form.Item name="platform" label="Platform">
                                                    <Select size="large">
                                                        <Option value="Apple MacBook">Apple MacBook</Option>
                                                        <Option value="PC Laptop">PC Laptop</Option>
                                                        <Option value="Chromebook">Chromebook</Option>
                                                    </Select>
                                                </Form.Item></Col>
                                                <Col span={8}><Form.Item name="convertible" label="Convertible"><Select size="large"><Option value="Yes">Yes</Option><Option value="No">No</Option></Select></Form.Item></Col>
                                            </>
                                        )}
                                    </Row>

                                </Card>
                            </div>
                        </Col>

                        {/* Right Column - Logistics & Pricing */}
                        <Col xs={24} lg={8}>
                            <div style={{ marginBottom: 32 }}>
                                <h3 style={{ fontSize: 18, fontWeight: 600, marginBottom: 16 }}>Inventory & Pricing</h3>
                                <Card variant="borderless" style={{ boxShadow: '0 2px 10px rgba(0,0,0,0.03)', borderRadius: 12 }}>
                                    <Form.Item name="price" label="Price" rules={[{ required: true }]}>
                                        <InputNumber
                                            size="large"
                                            style={{ width: '100%', fontWeight: 700 }}
                                            formatter={value => `$ ${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                                            parser={value => value!.replace(/\$\s?|(,*)/g, '')}
                                        />
                                    </Form.Item>

                                    <Row gutter={16}>
                                        <Col span={12}>
                                            <Form.Item name="quantity" label="Stock" rules={[{ required: true }]}>
                                                <InputNumber size="large" style={{ width: '100%' }} />
                                            </Form.Item>
                                        </Col>
                                        <Col span={12}>
                                            <Form.Item name="min_quantity_alert" label="Low Stock Alert">
                                                <InputNumber size="large" style={{ width: '100%' }} />
                                            </Form.Item>
                                        </Col>
                                    </Row>

                                    <Divider style={{ margin: '12px 0 24px' }} />

                                    <Form.Item name="shop_sku" label="Shop SKU" rules={[{ required: true }]}>
                                        <Input size="large" />
                                    </Form.Item>
                                    <Form.Item name="offer_sku" label="Offer SKU" rules={[{ required: true }]}>
                                        <Input size="large" />
                                    </Form.Item>
                                    <Form.Item name="upc" label="UPC Code" rules={[{ required: true }]}>
                                        <Input size="large" />
                                    </Form.Item>
                                </Card>
                            </div>

                            <div style={{ marginBottom: 32 }}>
                                <h3 style={{ fontSize: 18, fontWeight: 600, marginBottom: 16 }}>Logistics</h3>
                                <Card variant="borderless" style={{ boxShadow: '0 2px 10px rgba(0,0,0,0.03)', borderRadius: 12 }}>
                                    <Form.Item name="logistic_class" label="Shipping Class">
                                        <Select size="large">
                                            <Option value="Small Box">Small Box</Option>
                                            <Option value="Medium Box">Medium Box</Option>
                                            <Option value="Large Box">Large Box</Option>
                                        </Select>
                                    </Form.Item>
                                    <Form.Item name="warranty_days" label="Warranty (Days)" rules={[{ required: true }]}>
                                        <InputNumber size="large" style={{ width: '100%' }} />
                                    </Form.Item>
                                </Card>
                            </div>

                            <div style={{ marginBottom: 32 }}>
                                <h3 style={{ fontSize: 18, fontWeight: 600, marginBottom: 16 }}>EHF Fees</h3>
                                <Card variant="borderless" style={{ boxShadow: '0 2px 10px rgba(0,0,0,0.03)', borderRadius: 12 }}>
                                    <Row gutter={[12, 12]}>
                                        {['on', 'bc', 'ab', 'qc'].map(prov => (
                                            <Col span={12} key={prov}>
                                                <Form.Item name={`ehf_amount_${prov}`} label={prov.toUpperCase()} style={{ marginBottom: 0 }}>
                                                    <InputNumber size="middle" style={{ width: '100%' }} placeholder="0.00" />
                                                </Form.Item>
                                            </Col>
                                        ))}
                                        <Col span={24}>
                                            <Button type="link" style={{ padding: 0, marginTop: 8 }}>+ Show all provinces</Button>
                                        </Col>
                                    </Row>
                                </Card>
                            </div>
                        </Col>
                    </Row>
                </Form>
            )}
        </div>
    );
}
